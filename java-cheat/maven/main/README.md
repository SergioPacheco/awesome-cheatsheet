# Maven

Main Maven cheat.

Build tool and dependency manager comparable to Make and Python pip put together.

Tested with Maven 3.0.5 (Ubuntu 14.04).

Compile and test with:

    mvn test

Run `src/main/java/Main.java` with:

    mvn exec:java

Maven is very opinionated, and comes with many generally useful, complex and hard to customize defaults.

## Sources

Documentation index: <http://maven.apache.org/guides/index.html>

Maven by Example from Sonatype: <http://books.sonatype.com/mvnex-book/reference/index.html>

## Introduction

The Makefile for Maven is called `pom.xml`. XML-based, so very verbose.

Maven projects should use the following directory structure: <http://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html> This structure is generated by the default repository generation command:

Generate a test project:

    mvn archetype:generate -DgroupId=com.company.app -DartifactId=my-app -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false

Directory structure:

-   `target/`: what was built. Should be gitignored.

-   `src/`: all the source code.

    - `java/`: main application code
    - `test/`: test code

This directory was initially created with that command.

## Command line arguments

### D

Pass parameter to a plugin:

    mvn exec:java -D'exec.mainClass=com.company.app.Main'

Default parameters can also be set on the `pom.xml` `<configuration>` element. Passing them on the command line does *not* override the pom's value! <http://stackoverflow.com/questions/4660047/override-maven-plugin-configuration-defined-in-pluginmanagement-from-the-command>, <http://jira.codehaus.org/browse/MNG-4979>. The only way is to use a separate profile.

### q

Quiet operation.

Useful when running `mvn exec:java` so that you see only the actual program output.

### version

Shows the Maven version, and other useful system parameters, e.g. the `JAVA_HOME` and maven home. Sample output:

    Apache Maven 3.0.5
    Maven home: /usr/share/maven
    Java version: 1.8.0_31, vendor: Oracle Corporation
    Java home: /usr/lib/jvm/java-8-oracle/jre
    Default locale: en_US, platform encoding: UTF-8
    OS name: "linux", version: "3.13.0-48-generic", arch: "amd64", family: "unix"

## Repositories

Repositories are directories that contain dependencies that Maven can download.

They can be either regular files on the filesystem,or accessible through an HTTP server like Apache that maps the filesystem to remote URLs.

By default, Maven looks for dependencies from  the Repository Central: <http://search.maven.org/#browse|47> TODO: can anyone upload, or is it a silly curated only platform? <http://central.sonatype.org/> Apparently anything goes, but there is a mandatory manual review system that takes 2 days to prevent domain squatting...

You can add your own repositories

Minimal (TODO try to minimize more) `settings.xml` that adds uses local Maven repository:

    <settings>
        <localRepository>${user.home}/.m2/repository</localRepository>
        <profiles>
            <profile>
                <id>jdk-1.7</id>
                <activation>
                    <activeByDefault>true</activeByDefault>
                    <jdk>1.7</jdk>
                </activation>
                <repositories>
                    <repository>
                        <id>someid</id>
                        <name>Some Name</name>
                        <url>file://${user.home}/some/path</url>
                        <snapshots>
                            <enabled>false</enabled>
                        </snapshots>
                        <layout>default</layout>
                    </repository>
                </repositories>
            </profile>
        </profiles>
    </settings>

Maven copies all required dependencies (even if available locally) to `.m2/repository`.

When you do `mvn install`, Maven also places the compiled output under `.m2/repository` TODO where?

The format of external repositories is very similar to that of `.m2/repository`: just a `com/company/app/artifactId/version/artifactId-version.(jar|pom|md5|sha1)` directory structure. If you copy it directly under `.m2/repository` it will work.

Required repositories are downloaded on the fly as you run the commands that use them: you don't need to run specific commands to download dependencies.

## Goals

Makefile targets are called *goals*.

The standard "make app" command is `mvn clean install`.

Goals present by default: the following goals are called the *default life cycle*, and each one of them is also called a *phase*:

- `validate`
- `compile`
- `test`
- `package`
- `integration-test`
- `verify`
- `install`
- `deploy`

Calling any of those goals runs all the preceding ones, e.g. calling `deploy` runs everything.

### compile

### Compiler plugin

By default uses `org.apache.maven.plugins:maven-compiler-plugin`: <http://maven.apache.org/plugins/maven-compiler-plugin/>

Generates `.class` files from `.java` under `target/classes` for all `.java` files under `src/main/java`. Does not generate `.jar`: that is part of the `assembly`.

TODO: does compilation happen every time? Or only if sources were updated?

Make sure to set the `-source` and `-target` Java version on every project: the default is to use Java 1.3 whichever your current version.

### test

Provided by default by the Surefire plugin.

### Surefire plugin

Run all `.java` classes under `src/test/java` whose basenames without extension start or end with `Test`.

TODO: how does Surefire decide the JUnit version? Seems to work with both JUnit 3 and 4 without any configuration.

Run a single test class:

    mvn test -Dtest=TestMain

Runs all classes with that name independent of their package, e.g. both `TestMain` and `com.company.app.TestMain`.

Run a single test method:

    mvn test -Dtest=TestMain#asert

Test reports are stored under:

    target/surefire-reports

You can generate an HTML view of those reports with the `surefire-report` plugin.

Compiled test classes go under:

    target/test-classes

TODO: what exactly do the `.xml` and `.txt` files contain? Apparently, the `.xml` contain metadata, and the `.txt` test outputs and stack traces.

Package without testing:

    mvn package -DskipTests

Still compiles. Also don't compile:

    mvn package -Dmaven.test.skip=true

Pass command line arguments:

    <configuration>
        <argLine>-XX:PermSize=512m -XX:MaxPermSize=1024m</argLine>
    </configuration>

TODO: Fail fast, stop running on the first failure: <http://stackoverflow.com/questions/1923857/is-there-a-way-to-fail-fast-for-junit-with-the-maven-surefire-plugin>

#### Debug Maven Test with GDB

#### mvnDebug

<http://stackoverflow.com/questions/2935375/debugging-in-maven>

### surefire-report

Run tests and generate an HTML report containing failure percentage, running time, etc. from the output of surefire `target/surefire-reports`:

    mvn surefire-report:report

The output is placed at `target/site/surefire-report.html`, and can be viewed from the output of `mvn site`.

Only generate the report from the output of a previous test run, don't run the tests:

    mvn surefire-report:report-xml

### package

Offered by default by the Maven Jar plugin, but the Assembly Plugin is a popular alternative. The main difference is that the Assembly Plugin also packages all dependencies into the JAR, which is what you want if you are going to provide an executable jar via `java -jar a.jar`.

#### JAR plugin

<http://maven.apache.org/plugins/maven-jar-plugin/>

Default provider of the `package` phase. Does not include dependencies in the generated JAR.

#### Assembly plugin

<http://maven.apache.org/plugins/maven-assembly-plugin/usage.html>

Generates a `target/artifact-version.jar` containing all the classes under `src/main/java`.

Often attached to the package phase.

Provides as single goal:

    mvn assembly:single

Which generates an output `.jar` at: `target/artifactId-version-descriptorRef.jar`.

You must run `mvn compile` before assembling.

By default it does not set the `Main-Class` of the JAR. You can do it with:

    <plugin>
        <artifactId>maven-assembly-plugin</artifactId>
        <version>2.5.3</version>
        [...]
        <configuration>
            <archive>
                <manifest>
                    <mainClass>Main</mainClass>
                </manifest>
            </archive>
        </configuration>
    </plugin>

Each build needs an assembly descriptor: an `.xml` configuration file. You can use the built-in descriptors with:

    <artifactId>maven-assembly-plugin</artifactId>
    <version>2.5.3</version>
    <configuration>
        <descriptorRefs>
            <descriptorRef>jar-with-dependencies</descriptorRef>
        </descriptorRefs>
    </configuration>

The available descriptors are listed at: <http://maven.apache.org/plugins/maven-assembly-plugin/descriptor-refs.html>.

##### Attach assembly to the package phase

    <executions>
        <execution>
        <id>make-assembly</id>
        <phase>package</phase>
        <goals>
            <goal>single</goal>
        </goals>
        </execution>
    </executions>

Now you can run `mvn package` instead of `mvn assembly:single`. Install will also place those builds in your repository.

##### Custom assembly descriptors

For custom `assembly.xml` files, use:

	<plugin>
		<artifactId>maven-assembly-plugin</artifactId>
			<descriptors>
				<descriptor>assembly.xml</descriptor>
			</descriptors>

where `assembly.xml` is the relative path to the file.

The assembly descriptor top-level element:

	<assembly xmlns="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2" 
	  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	  xsi:schemaLocation="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2 http://maven.apache.org/xsd/assembly-1.1.2.xsd">

There are only two mandatory children:

- 	`id`: unique name that identifies this assembly. Gets added to the generated assembly file.

- 	`formats`: contains a list of archive `format` type: `zip`, `jar`, etc.:

		<formats>
			<format>zip</format>
			<format>jar</format>
		</formats>

Then you will also need other children that add at least one file to the assembly.

### install

Generate a `.jar` under `~/.m2` where it will be visible.

### Standalone goals

-   `clean`: remove `target` directory. Does not touch `~/.m2/repository`.

-   `idea:idea`: generate IntelliJ configuration files! Incredible how such complex things come in by default.

-   `eclipse:ecplise`: generate eclipse configuration files

Skip a goal:

    mvn clean install -DskipTests

#### site

Create a static website for your project.

You can manually create content for the website under `src/site`.

After running it, the website is placed under `target/site`.

There are also many plugins which generate output that is placed under `target/site`, and which can be then linked to from the main website:

- `javadoc`
- `surefire-reports`
- `dependencies`

`mvn site` invokes all those plugins by default.

### Plugins

Plugins are installed by adding to `build > plugins > plugin` of the `pom.xml`. The plugin element is analogous to the `dependency` one, and plugins are made available in public repositories just like regular dependencies.

List of important plugins: <http://maven.apache.org/plugins/index.html>

The major sources are:

- officially supported by Maven
- Mojo project from Codehaus
- Google code

TODO: possible to Git install?

Plugin goals for the plugin are run as:

    mvn <plugin>:<goal>

Specify full package and version of the plugin to be used:

    mvn <package>:<plugin>:<version>:<goal>

E.g.:

    mvn org.apache.maven.plugins:maven-dependency-plugin:2.1:get

Super verbose, and super robust.

Get help on the `exec` plugin:

    mvn exec:help

You can also use the full path of plugins to make them more explicit:

    mvn org.codehaus.mojo:exec-maven-plugin:java

Get full help on the `java` goal of the `exec` plugin:

    mvn install:help -Ddetail=true -Dgoal=install

TODO How to create a plugin? What is the API?

#### help plugin

<http://maven.apache.org/plugins/maven-help-plugin/>

Get various Maven debugging diagnostics.

Print the effective pom, with things like profiles factored:

    mvn help:effective-pom

TODO:

    mvn help:effective-settings

#### resources

Add non-Java files like data to your project:

    <plugin>
      <groupId>org.apache.maven.plugins</groupId>
      <artifactId>maven-resources-plugin</artifactId>
      <version>2.7</version>
      <configuration>
        <encoding>UTF-8</encoding>
      </configuration>
    </plugin>

Place the resource files under `src/(main|test)/resources`.

After `mvn clean install`:

-   resources under `src/main/resoruces` will be placed next to complied classes under `target/classes`

    Generated packages like jars will also contain those files.

#### exec

By Codehaus: <http://mojo.codehaus.org/exec-maven-plugin/>

Run Java files and executables from `mvn`.

Full help:

    mvn exec:help -Ddetail=true -Dgoal=java

Run a shell command `echo a b`:

    mvn exec:exec -D'exec.executable=echo' -D'exec.args=a b'

Run a compiled Java file with a `main` method of the application.

    mvn exec:java -D'exec.mainClass=Main'
    mvn exec:java -D'exec.mainClass=com.company.app.Main'

This does not compile the code: you must have run `mvn compile` before. TODO how to make that automatic?

You can set the default `mainClass` on your `pom.xml`, so you can run just:

    mvn exec:java

If your file organization of of type: `src/main/com/...` and `src/test/com...` and you want to exec `src/test/com/x/module/Main.java`, then you must pass a custom `classpathScope`:

    mvn exec:java -D'exec.mainClass=com.x.module.Main' -D'exec.classpathScope=test'

Command line arguments to the program:

    mvn exec:java -D'exec.mainClass=com.x.module.Main' -D'exec.args=arg0 arg1 arg2'

Java system properties: TODO what does `-DsystemProperties` do? <http://stackoverflow.com/questions/3708846/how-to-pass-systemproperties-when-invoking-execjava-plugin-in-maven>. How to set `-D'file.encoding=ISO-8859-1'` or `-ea`?

#### javadoc

<http://maven.apache.org/plugins/maven-javadoc-plugin/usage.html>

Install with:

    <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-javadoc-plugin</artifactId>
        <version>2.10.1</version>
        <configuration>
        ...
        </configuration>
    </plugin>

Make with:

    mvn javadoc:javadoc

By default, the output is placed at:

    target/site/apidocs/index.html

Generate a `.jar` containing the Javadoc:

    mvn javadoc:aggregate-jar

#### sources plugin

Generate a `target/artifactId-version-sources.jar` file containing all the non-test source files:

    mvn sources:jar

Applications:

-   distribute the source together with the compiled code. This is a common setup for open source projects, which distribute compiled code and sources side by side, the sources getting copied locally by maven.

    Eclipse is able to link to to the Javadoc from those sources, and to `F3` jump to and display the source files as well.

-   allow Eclipse to see the files and Javadoc even if you have closed some projects to make Eclipse faster. This is also useful for closed source projects.

Generate and install sources jar automatically on `mvn install`:

    <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-source-plugin</artifactId>
        <executions>
            <execution>
                <id>attach-sources</id>
                <goals>
                    <goal>jar</goal>
                </goals>
            </execution>
        </executions>
    </plugin>

#### dependency

List the dependencies of a project. TODO: understand:

    mvn dependency:tree
    mvn dependency:source

Also generates reports under `target/site/dependencies.html`.

Search for unnecessary dependencies <http://stackoverflow.com/questions/1517611/is-there-a-simple-way-to-remove-unused-dependencies-from-a-maven-pom-xml>:

    mvn dependency:analyze

Sample output excerpt:

    [INFO] --- maven-dependency-plugin:2.1:analyze (default-cli) @ spring ---
    [WARNING] Unused declared dependencies found:
    [WARNING]    org.springframework:spring-core:jar:4.1.5.RELEASE:compile
    [WARNING]    org.springframework:spring-beans:jar:4.1.5.RELEASE:compile

So `spring-core` and `spring-beans` were not needed.

Get a single dependency specified from the command line: <http://stackoverflow.com/questions/1776496/a-simple-command-line-to-download-a-remote-maven2-artifact-to-the-local-reposito>:

    mvn dependency:get \
        -DrepoUrl=http://download.java.net/maven/2/ \
        -Dartifact=robo-guice:robo-guice:0.4-SNAPSHOT

## pom.xml

<http://maven.apache.org/pom.html>

Per-repository configuration file.

-   `dependency`

    Sample:

        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>3.8.1</version>
            <scope>test</scope>
        </dependency>

    Where:

    - `groupId`: determines the path inside `.md2` where the file will be placed.
    - `artifactId`: determines part of the file and the filename.
    - `version`: besides explicit version numbers, can also take version ranges and other keywords like `LATEST`: <http://stackoverflow.com/questions/30571/how-do-i-tell-maven-to-use-the-latest-version-of-a-dependency>
    - `scope`: TODO

    `groupId` + `artifactId` + `version` together uniquely specify a dependency. They are often noted together as: `groupId:artifactId:version`.

### profile

TODO. Seems to allow you to have multiple profiles in one. Can be selected with the `-P` command line option.

<http://maven.apache.org/guides/introduction/introduction-to-profiles.html>

### parent

Includes another pom inside the current one:

    <parent>
        <groupId>com.company.app</groupId>
        <artifactId>my-artifact</artifactId>
        <version>1.0-SNAPSHOT</version>
    </parent>

Note that poms are stored in repositories, so that Maven is capable of retrieving it from there.

## M2_HOME

Where maven is installed.

`/usr/share/maven` by default on Ubuntu 14.04.

### .m2 directory

`~/.m2` on Linux by default. Can be configured with the TODO `M2` environment variable?

#### Repository

`repository`. Contains the `.jar` files that maven sees.

The directory that provides `com.company.app` is of the form:

`com/company/app/artifactId/<VERSION>/`

Then inside each version we can find:

- `artifactId-<VERSION>.(jar|pom|sha1|md5)`

where `artifactId` is set on the `pom`.

The pom is also present on the repository since it may be reused by other projects, e.g. through the `<parent>` element.

TODO:

- why do some of those have multiple `jar` or no `jar`?

For local filesystem imported repositories through `repositories` in `settings.xml`, the following file also appears:

- `_maven.repositories`. TODO.

#### settings.xml

Global configuration file.

TODO

## target directory

Where built files are put.

Should be gitignored.
